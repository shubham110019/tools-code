<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
    <title>Advanced Text to PDF Converter</title>
</head>

<body>

    <div class="container mt-5">
        <h2 class="mb-4">Advanced Text to PDF Converter</h2>

        <input type="file" id="txtFileInput" class="mb-3">
        <button class="btn btn-primary" onclick="convertToPDF()">Convert to PDF</button>

        <div class="mt-3" id="pdfPreviewSection" style="display: none;">
            <h4>File Name:</h4>
            <p id="fileName"></p>
            <h4>Preview PDF:</h4>
            <iframe id="pdfPreview" width="100%" height="500px"></iframe>
            <br>
            <a id="downloadLink" class="btn btn-success" onclick="downloadPDF()">Download PDF</a>
            <button class="btn btn-info" onclick="openInNewTab()">Open PDF in New Tab</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake/build/pdfmake.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake/build/vfs_fonts.js"></script>

    <script>
        let generatedBlob = null;
        let uploadedFileName = null;

        function convertToPDF() {
            const fileInput = document.getElementById('txtFileInput');
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a text file.');
                return;
            }

            uploadedFileName = file.name;

            const reader = new FileReader();
            reader.onload = function (e) {
                const textContent = e.target.result;
                generatePDF(textContent);
            };

            reader.readAsText(file);
        }

        function generatePDF(textContent) {
            const pdfDocDefinition = {
                content: [
                    {
                        text: textContent,
                        fontSize: 12,
                        margin: [0, 10, 0, 10],
                        // alignment: 'justify',
                        color: 'black',
                        bold: true,
                    }
                ]
            };

            pdfMake.createPdf(pdfDocDefinition).getBlob((blob) => {
                generatedBlob = blob;

                const pdfPreviewSection = document.getElementById('pdfPreviewSection');
                pdfPreviewSection.style.display = 'block';

                const pdfPreview = document.getElementById('pdfPreview');
                const url = URL.createObjectURL(blob);
                pdfPreview.src = url;

                // Ensure the URL is revoked when the iframe is unloaded
                pdfPreview.onload = function () {
                    URL.revokeObjectURL(url);
                };

                // Display the uploaded file name
                const fileNameElement = document.getElementById('fileName');
                fileNameElement.textContent = `Uploaded File Name: ${uploadedFileName}`;
            });
        }

        function downloadPDF() {
            if (generatedBlob) {
                const downloadLink = document.getElementById('downloadLink');
                const url = URL.createObjectURL(generatedBlob);

                // Set the download link with the uploaded file name and PDF extension
                downloadLink.href = url;
                downloadLink.download = uploadedFileName.replace(/\.[^/.]+$/, ".pdf");

                // Ensure the link is not reused, and revoke the URL after a short delay
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
            } else {
                alert('Please convert the text to PDF first.');
            }
        }

        function openInNewTab() {
            if (generatedBlob) {
                const url = URL.createObjectURL(generatedBlob);
                window.open(url, '_blank');
                // Ensure the URL is revoked after a short delay
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
            } else {
                alert('Please convert the text to PDF first.');
            }
        }
    </script>

</body>

</html>
